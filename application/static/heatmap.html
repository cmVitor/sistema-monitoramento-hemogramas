<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Calor - Monitoramento de Hemogramas</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        /* Hide Leaflet attribution */
        .leaflet-control-attribution {
            display: none !important;
        }

        /* Control Panel */
        .control-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            min-width: 320px;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .panel-title {
            color: #0f172a;
            font-size: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 20px;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: bold;
        }

        .toggle-btn:hover {
            color: #2563eb;
            background: rgba(37, 99, 235, 0.1);
        }

        /* Legend */
        .legend {
            margin-bottom: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            margin-right: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .legend-gradient {
            height: 24px;
            border-radius: 12px;
            margin: 12px 0;
            background: linear-gradient(90deg, 
                #22c55e 0%,    /* Verde - Normal */
                #eab308 20%,   /* Amarelo - Atenção */
                #f97316 40%,   /* Laranja - Alto */
                #dc2626 60%,   /* Vermelho - Crítico */
                #7c2d12 80%,   /* Marrom escuro - Surto */
                #4c1d95 100%   /* Roxo escuro - Surto crítico */
            );
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
            font-weight: 600;
        }

        /* Filter Options */
        .filter-section {
            margin-top: 15px;
        }

        .filter-option {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            margin: 10px 0;
            background: rgba(248, 250, 252, 0.8);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .filter-option:hover {
            background: rgba(37, 99, 235, 0.05);
            border-color: rgba(37, 99, 235, 0.2);
            transform: translateX(4px);
        }

        .filter-option.active {
            background: rgba(37, 99, 235, 0.1);
            border-color: #2563eb;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1);
        }

        .filter-option input[type="radio"] {
            margin-right: 14px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #2563eb;
        }

        .filter-option label {
            cursor: pointer;
            flex: 1;
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .intensity-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-left: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .outbreak-indicator {
            position: relative;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-left: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 3px solid #fbbf24;
            background: #7c2d12;
        }

        .outbreak-indicator::after {
            content: '⚠️';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 10px;
        }

        /* Statistics Panel */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-top: 18px;
        }

        .stat-item {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(59, 130, 246, 0.02));
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid rgba(37, 99, 235, 0.1);
            transition: all 0.2s;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(37, 99, 235, 0.1);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 800;
            color: #2563eb;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-top: 6px;
            font-weight: 600;
        }

        /* Outbreak Alert */
        .outbreak-alert {
            background: linear-gradient(135deg, rgba(124, 45, 18, 0.15), rgba(76, 29, 149, 0.1));
            border: 2px solid rgba(124, 45, 18, 0.4);
            border-radius: 12px;
            padding: 16px;
            margin-top: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .outbreak-icon {
            color: #7c2d12;
            font-size: 18px;
        }

        .outbreak-text {
            font-size: 13px;
            color: #7c2d12;
            font-weight: 600;
        }

        /* Collapsible sections */
        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        /* Custom popup styles */
        .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(226, 232, 240, 0.8);
        }

        .leaflet-popup-content {
            margin: 20px 24px;
            color: #1e293b;
            font-family: 'Inter', sans-serif;
        }

        .leaflet-popup-tip {
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid rgba(226, 232, 240, 0.8);
        }

        .popup-header {
            border-bottom: 3px solid;
            padding-bottom: 10px;
            margin-bottom: 16px;
            font-weight: 700;
            font-size: 16px;
        }

        .popup-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }

        .popup-label {
            color: #64748b;
            font-weight: 600;
        }

        .popup-value {
            font-weight: 700;
            color: #1e293b;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-outbreak {
            background: linear-gradient(135deg, rgba(124, 45, 18, 0.2), rgba(76, 29, 149, 0.15));
            color: #7c2d12;
            border: 2px solid rgba(124, 45, 18, 0.4);
            box-shadow: 0 0 10px rgba(124, 45, 18, 0.3);
        }

        .status-normal {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
            border: 2px solid rgba(34, 197, 94, 0.3);
        }

        /* Enhanced marker pulse animation for outbreaks */
        @keyframes pulse-outbreak {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(124, 45, 18, 0.8), 0 0 0 0 rgba(76, 29, 149, 0.4);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 0 8px rgba(124, 45, 18, 0.3), 0 0 0 15px rgba(76, 29, 149, 0.1);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(124, 45, 18, 0), 0 0 0 0 rgba(76, 29, 149, 0);
            }
        }

        .outbreak-marker {
            animation: pulse-outbreak 2.5s infinite;
        }

        /* Estilos para área de surto */
        @keyframes pulse-area {
            0%, 100% {
                opacity: 0.8;
            }
            50% {
                opacity: 1;
            }
        }

        .outbreak-area {
            animation: pulse-area 3s ease-in-out infinite;
        }

        /* Estilo para pontos dentro de surtos */
        .outbreak-point {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .outbreak-point:hover {
            transform: scale(1.3);
        }

        /* Label de região de surto */
        .outbreak-label {
            z-index: 1000;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Control Panel -->
    <div class="control-panel">
        <!-- Legend Panel -->
        <div class="panel-card">
            <div class="panel-header">
                <span class="panel-title">Legenda</span>
                <button class="toggle-btn" onclick="toggleSection('legend')">−</button>
            </div>
            <div id="legend" class="collapsible-content">
                <div class="legend">
                    <div class="legend-gradient"></div>
                    <div class="legend-labels">
                        <span>Normal</span>
                        <span>Atenção</span>
                        <span>Alto</span>
                        <span>Crítico</span>
                        <span>Surto</span>
                    </div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #22c55e;"></div>
                    <span>0 - 5.000 leucócitos (Normal)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #eab308;"></div>
                    <span>5.000 - 10.000 leucócitos (Atenção)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f97316;"></div>
                    <span>10.000 - 15.000 leucócitos (Alto)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc2626;"></div>
                    <span>15.000+ leucócitos (Crítico)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #7c2d12, #4c1d95); border-color: #fbbf24; border-width: 3px;"></div>
                    <span>Região com surto ativo ⚠️</span>
                </div>
            </div>
        </div>

        <!-- Filter Panel -->
        <div class="panel-card">
            <div class="panel-header">
                <span class="panel-title">Filtros</span>
                <button class="toggle-btn" onclick="toggleSection('filters')">−</button>
            </div>
            <div id="filters" class="collapsible-content">
                <div class="filter-section">
                    <div class="filter-option active" data-filter="all">
                        <input type="radio" id="filter-all" name="intensity" value="all" checked>
                        <label for="filter-all">Todos os Casos</label>
                    </div>
                    <div class="filter-option" data-filter="outbreak">
                        <input type="radio" id="filter-outbreak" name="intensity" value="outbreak">
                        <label for="filter-outbreak">Apenas Surtos</label>
                        <div class="outbreak-indicator"></div>
                    </div>
                    <div class="filter-option" data-filter="low">
                        <input type="radio" id="filter-low" name="intensity" value="low">
                        <label for="filter-low">Nível Normal</label>
                        <div class="intensity-indicator" style="background: #22c55e;"></div>
                    </div>
                    <div class="filter-option" data-filter="normal">
                        <input type="radio" id="filter-normal" name="intensity" value="normal">
                        <label for="filter-normal">Nível Atenção</label>
                        <div class="intensity-indicator" style="background: #eab308;"></div>
                    </div>
                    <div class="filter-option" data-filter="high">
                        <input type="radio" id="filter-high" name="intensity" value="high">
                        <label for="filter-high">Nível Alto</label>
                        <div class="intensity-indicator" style="background: #f97316;"></div>
                    </div>
                    <div class="filter-option" data-filter="critical">
                        <input type="radio" id="filter-critical" name="intensity" value="critical">
                        <label for="filter-critical">Nível Crítico</label>
                        <div class="intensity-indicator" style="background: #dc2626;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Panel -->
        <div class="panel-card">
            <div class="panel-header">
                <span class="panel-title">Estatísticas</span>
                <button class="toggle-btn" onclick="toggleSection('stats')">−</button>
            </div>
            <div id="stats" class="collapsible-content">
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="total-cases">0</span>
                        <span class="stat-label">Total de Casos</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="outbreak-count">0</span>
                        <span class="stat-label">Surtos Ativos</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="critical-cases">0</span>
                        <span class="stat-label">Casos Críticos</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avg-intensity">0</span>
                        <span class="stat-label">Média Leucócitos</span>
                    </div>
                </div>
                
                <div class="outbreak-alert" id="outbreak-alert" style="display: none;">
                    <span class="outbreak-icon">⚠️</span>
                    <div class="outbreak-text">
                        <strong>Alerta de Surto:</strong> <span id="outbreak-regions">0</span> região(ões) com surto ativo detectado
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Heat Plugin -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
        // Initialize map centered on Brazil
        const map = L.map('map', {
            zoomControl: false,
            preferCanvas: true
        }).setView([-14.235, -51.925], 4);

        // Light, clear tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '',
            maxZoom: 18
        }).addTo(map);

        let heatLayer = null;
        let markersLayer = L.layerGroup().addTo(map);
        let outbreakAreasLayer = L.layerGroup().addTo(map);
        let allData = [];
        let outbreakRegions = {}; // Computed by backend with centroid, radius, phone numbers
        let currentFilter = 'all';

        // Distinct color scheme with clear differentiation
        const colorScheme = {
            low: '#22c55e',      // Verde - Normal
            normal: '#eab308',   // Amarelo - Atenção  
            high: '#f97316',     // Laranja - Alto
            critical: '#dc2626', // Vermelho - Crítico
            outbreak: '#7c2d12'  // Marrom escuro - Surto (bem diferente do vermelho)
        };

        // Toggle section functionality
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const button = section.previousElementSibling.querySelector('.toggle-btn');
            
            section.classList.toggle('collapsed');
            button.textContent = section.classList.contains('collapsed') ? '+' : '−';
        }

        // Filter functionality
        const filterOptions = document.querySelectorAll('.filter-option');
        filterOptions.forEach(option => {
            option.addEventListener('click', function() {
                filterOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                this.querySelector('input[type="radio"]').checked = true;

                currentFilter = this.dataset.filter;
                updateHeatmap();
            });
        });

        function filterDataByIntensity(data, filter) {
            if (filter === 'all') return data;

            return data.filter(point => {
                const intensity = point.intensity;
                switch(filter) {
                    case 'outbreak':
                        return point.region_outbreak === true;
                    case 'low':
                        return intensity >= 0 && intensity < 5000;
                    case 'normal':
                        return intensity >= 5000 && intensity < 10000;
                    case 'high':
                        return intensity >= 10000 && intensity < 15000;
                    case 'critical':
                        return intensity >= 15000;
                    default:
                        return true;
                }
            });
        }

        function getColorByIntensity(intensity, isOutbreak = false) {
            if (isOutbreak) {
                return colorScheme.outbreak; // Marrom escuro para surtos
            }
            
            if (intensity < 5000) {
                return colorScheme.low;
            } else if (intensity < 10000) {
                return colorScheme.normal;
            } else if (intensity < 15000) {
                return colorScheme.high;
            } else {
                return colorScheme.critical;
            }
        }

        function groupDataByRegion(data) {
            const regions = {};
            data.forEach(point => {
                const region = point.region;
                if (!regions[region]) {
                    regions[region] = {
                        points: [],
                        hasOutbreak: false
                    };
                }
                regions[region].points.push(point);
                if (point.region_outbreak) {
                    regions[region].hasOutbreak = true;
                }
            });
            return regions;
        }

        // Funções de cálculo movidas para o backend (services/geospatial.py)
        // Backend agora retorna centroid e radius pré-calculados

        function updateStatistics(data) {
            const totalCases = data.length;
            const outbreakRegions = new Set(data.filter(p => p.region_outbreak).map(p => p.region));
            const outbreakCount = outbreakRegions.size;
            const criticalCases = data.filter(p => p.intensity >= 15000).length;
            const avgIntensity = data.length > 0 ?
                (data.reduce((sum, p) => sum + p.intensity, 0) / data.length).toFixed(0) : 0;

            document.getElementById('total-cases').textContent = totalCases.toLocaleString();
            document.getElementById('outbreak-count').textContent = outbreakCount;
            document.getElementById('critical-cases').textContent = criticalCases;
            document.getElementById('avg-intensity').textContent = avgIntensity;

            // Show/hide outbreak alert
            const outbreakAlert = document.getElementById('outbreak-alert');
            if (outbreakCount > 0) {
                outbreakAlert.style.display = 'flex';
                document.getElementById('outbreak-regions').textContent = outbreakCount;
            } else {
                outbreakAlert.style.display = 'none';
            }
        }

        function updateHeatmap() {
            const filteredData = filterDataByIntensity(allData, currentFilter);

            // Remove old layers
            if (heatLayer) {
                map.removeLayer(heatLayer);
            }
            markersLayer.clearLayers();
            outbreakAreasLayer.clearLayers();

            // Update statistics
            updateStatistics(filteredData);

            // Agrupar dados por região
            const regionGroups = groupDataByRegion(filteredData);

            // Separar dados por tipo de região
            const outbreakData = [];
            const normalData = [];

            Object.entries(regionGroups).forEach(([region, data]) => {
                if (data.hasOutbreak) {
                    outbreakData.push(...data.points);
                } else {
                    normalData.push(...data.points);
                }
            });

            // 1. Criar heatmap apenas para regiões normais (sem surto)
            if (normalData.length > 0) {
                const heatData = normalData.map(point => {
                    let normalizedIntensity;

                    if (point.intensity >= 15000) {
                        normalizedIntensity = 0.75; // Critical
                    } else if (point.intensity >= 10000) {
                        normalizedIntensity = 0.55; // High
                    } else if (point.intensity >= 5000) {
                        normalizedIntensity = 0.35;  // Normal/Attention
                    } else {
                        normalizedIntensity = 0.15;  // Low/Normal
                    }

                    return [point.lat, point.lng, normalizedIntensity];
                });

                heatLayer = L.heatLayer(heatData, {
                    radius: 35,
                    blur: 20,
                    maxZoom: 10,
                    max: 1.0,
                    gradient: {
                        0.0: 'rgba(34, 197, 94, 0.4)',   // Verde transparente
                        0.25: 'rgba(234, 179, 8, 0.5)',  // Amarelo
                        0.45: 'rgba(249, 115, 22, 0.6)', // Laranja
                        0.65: 'rgba(220, 38, 38, 0.7)',  // Vermelho
                        1.0: 'rgba(185, 28, 28, 0.8)'    // Vermelho mais escuro
                    }
                }).addTo(map);

                // Adicionar marcadores para regiões normais
                normalData.forEach(point => {
                    const markerColor = getColorByIntensity(point.intensity, false);

                    const marker = L.circleMarker([point.lat, point.lng], {
                        radius: 5,
                        fillColor: markerColor,
                        color: '#ffffff',
                        weight: 2,
                        opacity: 0.9,
                        fillOpacity: 0.7,
                        className: 'normal-marker'
                    });

                    const intensityLevel = point.intensity < 5000 ? 'Normal' :
                                         point.intensity < 10000 ? 'Atenção' :
                                         point.intensity < 15000 ? 'Alto' : 'Crítico';

                    marker.bindPopup(`
                        <div>
                            <h4 class="popup-header" style="border-color: ${markerColor};">
                                Região ${point.region}
                            </h4>
                            <div class="popup-row">
                                <span class="popup-label">Status:</span>
                                <span class="status-badge status-normal">✓ Normal</span>
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">Leucócitos:</span>
                                <span class="popup-value">${point.intensity ? point.intensity.toLocaleString() : 'N/A'}</span>
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">Nível:</span>
                                <span class="popup-value" style="color: ${markerColor}; font-weight: 800;">${intensityLevel}</span>
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">Casos (7d):</span>
                                <span class="popup-value">${point.region_case_count || 0}</span>
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">Última atualização:</span>
                                <span class="popup-value">${point.received_at ? new Date(point.received_at).toLocaleString('pt-BR') : 'N/A'}</span>
                            </div>
                        </div>
                    `);

                    marker.addTo(markersLayer);
                });
            }

            // 2. Criar áreas delimitadas para surtos com pontos individuais
            // AGORA USA DADOS PRÉ-CALCULADOS DO BACKEND
            Object.entries(regionGroups).forEach(([region, data]) => {
                if (!data.hasOutbreak) return;

                const points = data.points;

                // Usar centroid e radius calculados pelo backend
                const outbreakInfo = outbreakRegions[region];
                if (!outbreakInfo) {
                    console.warn(`Dados de surto não encontrados para região ${region}`);
                    return;
                }

                const centroid = outbreakInfo.centroid;
                const radius = outbreakInfo.radius;

                // Criar círculo delimitador da área de surto
                const outbreakArea = L.circle([centroid.lat, centroid.lng], {
                    radius: radius,
                    fillColor: '#7c2d12',
                    fillOpacity: 0.08,
                    color: '#fbbf24',
                    weight: 3,
                    opacity: 0.8,
                    dashArray: '10, 10',  // Linha pontilhada
                    className: 'outbreak-area'
                });

                // Adicionar label da região no centro
                const regionLabel = L.marker([centroid.lat, centroid.lng], {
                    icon: L.divIcon({
                        className: 'outbreak-label',
                        html: `<div style="
                            background: rgba(124, 45, 18, 0.95);
                            color: white;
                            padding: 8px 16px;
                            border-radius: 20px;
                            font-weight: 700;
                            font-size: 13px;
                            border: 3px solid #fbbf24;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            white-space: nowrap;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        ">⚠️ SURTO - Região ${region} (${outbreakInfo.point_count} casos)</div>`,
                        iconSize: [200, 40],
                        iconAnchor: [100, 20]
                    }),
                    interactive: false
                });

                outbreakArea.addTo(outbreakAreasLayer);
                regionLabel.addTo(outbreakAreasLayer);

                // Adicionar pontos individuais dentro da área de surto
                points.forEach(point => {
                    // Cor baseada no nível de leucócitos individual
                    const markerColor = getColorByIntensity(point.intensity, false);

                    const marker = L.circleMarker([point.lat, point.lng], {
                        radius: 8,
                        fillColor: markerColor,
                        color: '#ffffff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9,
                        className: 'outbreak-point'
                    });

                    const intensityLevel = point.intensity < 5000 ? 'Normal' :
                                         point.intensity < 10000 ? 'Atenção' :
                                         point.intensity < 15000 ? 'Alto' : 'Crítico';

                    marker.bindPopup(`
                        <div>
                            <h4 class="popup-header" style="border-color: #7c2d12; background: linear-gradient(135deg, rgba(124, 45, 18, 0.15), rgba(76, 29, 149, 0.1));">
                                ⚠️ Região ${point.region} - SURTO
                            </h4>
                            <div class="popup-row">
                                <span class="popup-label">Status da Região:</span>
                                <span class="status-badge status-outbreak">⚠️ SURTO ATIVO</span>
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">Leucócitos (este ponto):</span>
                                <span class="popup-value">${point.intensity ? point.intensity.toLocaleString() : 'N/A'}</span>
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">Nível deste ponto:</span>
                                <span class="popup-value" style="color: ${markerColor}; font-weight: 800;">${intensityLevel}</span>
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">Total de casos na região (7d):</span>
                                <span class="popup-value">${point.region_case_count || 0}</span>
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">Última atualização:</span>
                                <span class="popup-value">${point.received_at ? new Date(point.received_at).toLocaleString('pt-BR') : 'N/A'}</span>
                            </div>
                        </div>
                    `);

                    marker.addTo(markersLayer);
                });
            });

            console.log(`Exibindo ${filteredData.length} pontos (${outbreakData.length} em surtos, ${normalData.length} normais)`);
        }

        function loadHeatmapData() {
            fetch('/heatmap-data')
                .then(response => response.json())
                .then(data => {
                    // Backend agora retorna { observations: [], outbreaks: {} }
                    allData = data.observations || [];
                    outbreakRegions = data.outbreaks || {};
                    updateHeatmap();
                    console.log(`Carregados ${allData.length} pontos para o mapa de calor`);
                })
                .catch(error => {
                    console.error('Erro ao carregar dados do mapa de calor:', error);
                });
        }

        // Initial load
        loadHeatmapData();

        // Auto-refresh every 30 seconds
        setInterval(loadHeatmapData, 30000);
    </script>
</body>
</html>